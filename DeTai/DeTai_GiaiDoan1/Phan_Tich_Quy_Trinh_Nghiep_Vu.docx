# PHÃ‚N TÃCH QUY TRÃŒNH NGHIá»†P Vá»¤
## Website ThÆ°Æ¡ng Máº¡i Äiá»‡n Tá»­ Fear Of God

---

## 1. QUY TRÃŒNH BÃM SÃT THá»°C Táº¾ Vá»šI CODE KHÃ”NG?

### 1.1. ÄÃ¡nh giÃ¡ tá»•ng quan

Quy trÃ¬nh nghiá»‡p vá»¥ Ä‘Æ°á»£c mÃ´ táº£ trong Activity Diagram **BÃM SÃT CAO** vá»›i code thá»±c táº¿ cá»§a dá»± Ã¡n. DÆ°á»›i Ä‘Ã¢y lÃ  phÃ¢n tÃ­ch chi tiáº¿t:

### 1.2. Quy trÃ¬nh Danh má»¥c sáº£n pháº©m

**âœ… BÃ¡m sÃ¡t thá»±c táº¿:**

- **API GET /**: Hiá»ƒn thá»‹ toÃ n bá»™ danh sÃ¡ch sáº£n pháº©m
  - Code thá»±c táº¿: `module.exports.index` trong `product.controller.js`
  - Truy váº¥n: `Products.find()` tráº£ vá» táº¥t cáº£ sáº£n pháº©m

- **API GET /category/pagination**: TÃ¬m kiáº¿m, lá»c, phÃ¢n trang
  - Code thá»±c táº¿: `module.exports.pagination` trong `product.controller.js`
  - Há»— trá»£: `page`, `count`, `search`, `category`
  - Logic lá»c theo tá»« khÃ³a: `value.name_product.toUpperCase().indexOf(keyWordSearch.toUpperCase())`

- **API GET /:id**: Xem chi tiáº¿t sáº£n pháº©m
  - Code thá»±c táº¿: `module.exports.detail` trong `product.controller.js`
  - Truy váº¥n: `Products.findOne({ _id: id })`

- **Hiá»ƒn thá»‹ thÃ´ng tin**: TÃªn, giÃ¡, hÃ¬nh áº£nh, tá»“n kho
  - Model `product.js` chá»©a cÃ¡c trÆ°á»ng: `name_product`, `price_product`, `image`, `stock`

**ğŸ” Káº¿t luáº­n**: Quy trÃ¬nh nÃ y bÃ¡m sÃ¡t 100% vá»›i code thá»±c táº¿.

---

### 1.3. Quy trÃ¬nh Giá» hÃ ng

**âœ… BÃ¡m sÃ¡t thá»±c táº¿:**

- **ThÃªm vÃ o giá» hÃ ng**: 
  - Sá»­ dá»¥ng `localStorage` vá»›i key `"carts"`
  - Code: `localStorage.setItem('carts', JSON.stringify([]))`
  - Component: `CartsLocal.js` xá»­ lÃ½ CRUD giá» hÃ ng

- **Cáº­p nháº­t Redux State**:
  - Action: `changeCount()` trong `ActionCount.js`
  - Dispatch khi thÃªm/xÃ³a/cáº­p nháº­t giá» hÃ ng
  - Code: `dispatch(action_change_count)`

- **Hiá»ƒn thá»‹ tÃ³m táº¯t giá» hÃ ng**:
  - Component `Cart.jsx` hiá»ƒn thá»‹ danh sÃ¡ch sáº£n pháº©m
  - HÃ m `Sum_Price()` tÃ­nh tá»•ng tiá»n
  - Há»— trá»£ Ã¡p dá»¥ng coupon (giáº£m giÃ¡)

- **XÃ³a sáº£n pháº©m**:
  - HÃ m `handler_delete_carts(id_cart)`
  - Gá»i `CartsLocal.deleteProduct(id_cart)`
  - Tá»± Ä‘á»™ng cáº­p nháº­t láº¡i tá»•ng tiá»n

**ğŸ” Káº¿t luáº­n**: Quy trÃ¬nh nÃ y bÃ¡m sÃ¡t 95% vá»›i code thá»±c táº¿. 
- **LÆ°u Ã½**: Giá» hÃ ng Ä‘Æ°á»£c lÆ°u á»Ÿ localStorage (client-side), khÃ´ng cÃ³ API lÆ°u trÃªn server.

---

### 1.4. Quy trÃ¬nh BÃ¡n hÃ ng (Äáº·t hÃ ng + Thanh toÃ¡n)

**âœ… BÃ¡m sÃ¡t thá»±c táº¿:**

- **Checkout Form**:
  - Component: `Checkout.jsx`
  - Form nháº­p: `fullname`, `phone`, `address`, `email`
  - State: `information` lÆ°u trá»¯ thÃ´ng tin khÃ¡ch hÃ ng

- **TÃ­nh phÃ­ váº­n chuyá»ƒn**:
  - Component: `MapComponent.jsx` sá»­ dá»¥ng Google Maps API
  - TÃ­nh khoáº£ng cÃ¡ch vÃ  phÃ­ ship
  - LÆ°u vÃ o `localStorage.setItem("price", shippingPrice)`

- **Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n**:
  - **PayPal**: Component `Paypal.jsx`
  - **MoMo**: Component `MoMo.jsx` 
    - API: `POST /momo` kiá»ƒm tra signature vÃ  xá»­ lÃ½ callback
    - Code: `order.controller.js` - `module.exports.post_momo`
  - **COD**: Thanh toÃ¡n khi nháº­n hÃ ng (khÃ´ng cáº§n xá»­ lÃ½ online)

- **Táº¡o Ä‘Æ¡n hÃ ng**:
  - API: `POST /order`
  - Code: `module.exports.post_order` trong `order.controller.js`
  - Táº¡o document trong collection `Order`

- **Táº¡o chi tiáº¿t Ä‘Æ¡n hÃ ng**:
  - Model: `detail_order.js`
  - LÆ°u tá»«ng sáº£n pháº©m trong Ä‘Æ¡n vá»›i: `id_product`, `count`, `size`, `price`

- **Gá»­i email xÃ¡c nháº­n**:
  - API: `POST /email`
  - Code: `module.exports.send_mail` trong `order.controller.js`
  - Sá»­ dá»¥ng `mailer.js` vá»›i SMTP Gmail
  - Ná»™i dung HTML chá»©a: báº£ng sáº£n pháº©m, tá»•ng tiá»n, thÃ´ng tin giao hÃ ng

**ğŸ” Káº¿t luáº­n**: Quy trÃ¬nh nÃ y bÃ¡m sÃ¡t 98% vá»›i code thá»±c táº¿.
- **Äiá»ƒm máº¡nh**: TÃ­ch há»£p Ä‘áº§y Ä‘á»§ PayPal, MoMo, Google Maps
- **LÆ°u Ã½**: Quáº£n lÃ½ tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua Admin Dashboard

---

### 1.5. Quy trÃ¬nh XÃ¡c nháº­n Email

**âœ… BÃ¡m sÃ¡t thá»±c táº¿:**

- **Láº¥y chi tiáº¿t Ä‘Æ¡n hÃ ng**:
  - Code: `Detail_Order.find({ id_order: req.body.id_order }).populate('id_product')`
  - Populate Ä‘á»ƒ láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§ cá»§a sáº£n pháº©m

- **XÃ¢y dá»±ng HTML email**:
  - Template HTML: Báº£ng vá»›i cá»™t (TÃªn, HÃ¬nh áº£nh, GiÃ¡, Sá»‘ lÆ°á»£ng, Size, ThÃ nh tiá»n)
  - VÃ²ng láº·p qua `carts` Ä‘á»ƒ táº¡o cÃ¡c hÃ ng trong báº£ng
  - ThÃªm thÃ´ng tin: Há» tÃªn, SÄT, Ä‘á»‹a chá»‰, phÃ­ ship, tá»•ng thanh toÃ¡n

- **Gá»­i email qua SMTP**:
  - File: `mailer.js`
  - Host: `smtp.gmail.com`, Port: `587`
  - Email: `truongphukiet1211@gmail.com`
  - Sá»­ dá»¥ng App Password cá»§a Google (khÃ´ng dÃ¹ng password thÆ°á»ng)
  - Subject: "HÃ³a ÄÆ¡n Äáº·t HÃ ng"

- **KhÃ¡ch hÃ ng nháº­n email**:
  - Email chá»©a Ä‘áº§y Ä‘á»§ thÃ´ng tin Ä‘Æ¡n hÃ ng
  - CÃ³ thá»ƒ dÃ¹ng lÃ m biÃªn lai Ä‘iá»‡n tá»­

**ğŸ” Káº¿t luáº­n**: Quy trÃ¬nh nÃ y bÃ¡m sÃ¡t 100% vá»›i code thá»±c táº¿.

---

## 2. QUY TRÃŒNH MUA - BÃN TRÃŠN WEBSITE THÆ¯Æ NG Máº I ÄIá»†N Tá»¬, Náº¾U TÃCH NHá» RA, THÃŒ CÃ“ Váº¤N Äá»€ PHá»I Há»¢P KHÃ”NG Náº¾U TÃCH CÃC QUY TRÃŒNH: ÄÆ¡N HÃ€NG, THANH TOÃN, QUáº¢N LÃ ÄÆ N?

### 2.1. PhÃ¢n tÃ­ch kiáº¿n trÃºc hiá»‡n táº¡i

Trong dá»± Ã¡n nÃ y, cÃ¡c quy trÃ¬nh Ä‘Ã£ Ä‘Æ°á»£c **TÃCH BIá»†T RÃ• RÃ€NG** thÃ nh cÃ¡c module Ä‘á»™c láº­p:

#### 2.1.1. Module ÄÆ¡n hÃ ng (Order)
- **Model**: `order.js`
- **Router**: `order.router.js`
- **Controller**: `order.controller.js`
- **API**:
  - `GET /order/:id` - Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a user
  - `GET /order/detail/:id` - Láº¥y chi tiáº¿t 1 Ä‘Æ¡n hÃ ng
  - `POST /order` - Táº¡o Ä‘Æ¡n hÃ ng má»›i

#### 2.1.2. Module Chi tiáº¿t Ä‘Æ¡n hÃ ng (Detail Order)
- **Model**: `detail_order.js`
- **Router**: `detail_order.router.js`
- **Controller**: `detail_order.controller.js`
- **Chá»©c nÄƒng**: LÆ°u trá»¯ tá»«ng sáº£n pháº©m trong Ä‘Æ¡n hÃ ng

#### 2.1.3. Module Thanh toÃ¡n (Payment)
- **Model**: `payment.js`
- **API trong Order Controller**:
  - `POST /momo` - Xá»­ lÃ½ callback tá»« MoMo
  - PayPal Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ client-side (Paypal.jsx)
- **PhÆ°Æ¡ng thá»©c**: PayPal, MoMo, COD

#### 2.1.4. Module Giao hÃ ng (Delivery)
- **Model**: `delivery.js`
- **Router**: `delivery.router.js`
- **Controller**: `delivery.controller.js`
- **Chá»©c nÄƒng**: Quáº£n lÃ½ thÃ´ng tin giao hÃ ng, phÃ­ váº­n chuyá»ƒn

---

### 2.2. CÃ¡c váº¥n Ä‘á» phá»‘i há»£p cÃ³ thá»ƒ xáº£y ra

#### âš ï¸ Váº¥n Ä‘á» 1: Äá»“ng bá»™ dá»¯ liá»‡u giá»¯a cÃ¡c module

**TÃ¬nh huá»‘ng**:
- Khi táº¡o Ä‘Æ¡n hÃ ng (Order), cáº§n Ä‘á»“ng thá»i táº¡o:
  - Chi tiáº¿t Ä‘Æ¡n hÃ ng (Detail_Order)
  - ThÃ´ng tin thanh toÃ¡n (Payment)
  - ThÃ´ng tin giao hÃ ng (Delivery)

**Giáº£i phÃ¡p trong code hiá»‡n táº¡i**:
```javascript
// Táº¡o Ä‘Æ¡n hÃ ng
const order = await Order.create(req.body)

// Táº¡o chi tiáº¿t Ä‘Æ¡n hÃ ng (thá»±c hiá»‡n riÃªng)
// Gá»­i email xÃ¡c nháº­n
await mailer.sendMail(...)
```

**Váº¥n Ä‘á»**: 
- Náº¿u táº¡o Order thÃ nh cÃ´ng nhÆ°ng táº¡o Detail_Order tháº¥t báº¡i â†’ **Dá»¯ liá»‡u khÃ´ng Ä‘á»“ng bá»™**
- KhÃ´ng cÃ³ **transaction** Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u

**âš¡ Khuyáº¿n nghá»‹**: Sá»­ dá»¥ng MongoDB Transaction Ä‘á»ƒ Ä‘áº£m báº£o táº¥t cáº£ cÃ¡c bÆ°á»›c Ä‘á»u thÃ nh cÃ´ng hoáº·c rollback.

---

#### âš ï¸ Váº¥n Ä‘á» 2: Xá»­ lÃ½ thanh toÃ¡n báº¥t Ä‘á»“ng bá»™

**TÃ¬nh huá»‘ng**:
- Thanh toÃ¡n PayPal/MoMo cÃ³ thá»ƒ máº¥t vÃ i giÃ¢y
- Trong thá»i gian chá», khÃ¡ch hÃ ng cÃ³ thá»ƒ:
  - ÄÃ³ng trÃ¬nh duyá»‡t
  - Máº¥t káº¿t ná»‘i máº¡ng
  - Refresh trang

**Giáº£i phÃ¡p trong code hiá»‡n táº¡i**:
- MoMo cÃ³ callback API: `POST /momo` Ä‘á»ƒ nháº­n káº¿t quáº£ thanh toÃ¡n
- Kiá»ƒm tra `signature` Ä‘á»ƒ xÃ¡c thá»±c request tá»« MoMo
- Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng dá»±a trÃªn `errorCode`

**Váº¥n Ä‘á»**:
- Náº¿u callback tá»« MoMo bá»‹ delay hoáº·c fail â†’ Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng khÃ´ng Ä‘Æ°á»£c cáº­p nháº­t
- PayPal Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ client-side â†’ Dá»… bá»‹ giáº£ máº¡o

**âš¡ Khuyáº¿n nghá»‹**: 
- LÆ°u tráº¡ng thÃ¡i thanh toÃ¡n trung gian: "PENDING", "PROCESSING", "COMPLETED", "FAILED"
- Implement webhook tá»« PayPal Ä‘á»ƒ nháº­n káº¿t quáº£ thanh toÃ¡n chÃ­nh xÃ¡c

---

#### âš ï¸ Váº¥n Ä‘á» 3: Quáº£n lÃ½ tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng

**TÃ¬nh huá»‘ng**:
- ÄÆ¡n hÃ ng cÃ³ nhiá»u tráº¡ng thÃ¡i: Chá» xá»­ lÃ½ â†’ Äang giao â†’ HoÃ n thÃ nh â†’ Há»§y
- Admin cáº§n cáº­p nháº­t tráº¡ng thÃ¡i tá»« Admin Dashboard
- Customer cáº§n theo dÃµi tráº¡ng thÃ¡i real-time

**Giáº£i phÃ¡p trong code hiá»‡n táº¡i**:
- Dá»± Ã¡n cÃ³ sá»­ dá»¥ng **Socket.io**:
  ```javascript
  const socket = io('http://localhost:8000', {
      transports: ['websocket'], jsonp: false
  });
  ```
- Cho phÃ©p cáº­p nháº­t real-time

**Váº¥n Ä‘á»**:
- KhÃ´ng rÃµ flow cáº­p nháº­t tráº¡ng thÃ¡i tá»« Admin â†’ Customer
- Náº¿u tÃ¡ch module Quáº£n lÃ½ Ä‘Æ¡n hÃ ng riÃªng â†’ Cáº§n Ä‘áº£m báº£o WebSocket hoáº¡t Ä‘á»™ng xuyÃªn suá»‘t

**âš¡ Khuyáº¿n nghá»‹**: 
- Sá»­ dá»¥ng Event-Driven Architecture
- Khi Admin cáº­p nháº­t tráº¡ng thÃ¡i â†’ Emit event qua Socket.io â†’ Client nháº­n vÃ  cáº­p nháº­t UI

---

#### âš ï¸ Váº¥n Ä‘á» 4: Rollback khi thanh toÃ¡n tháº¥t báº¡i

**TÃ¬nh huá»‘ng**:
- KhÃ¡ch hÃ ng Ä‘áº·t hÃ ng thÃ nh cÃ´ng
- Thanh toÃ¡n PayPal/MoMo tháº¥t báº¡i
- Cáº§n **há»§y Ä‘Æ¡n hÃ ng** vÃ  **hoÃ n tráº£ stock** sáº£n pháº©m

**Giáº£i phÃ¡p trong code hiá»‡n táº¡i**:
- KhÃ´ng tháº¥y logic kiá»ƒm tra vÃ  trá»« stock
- KhÃ´ng cÃ³ cÆ¡ cháº¿ rollback tá»± Ä‘á»™ng

**âš¡ Khuyáº¿n nghá»‹**: 
- Implement check stock trÆ°á»›c khi thanh toÃ¡n
- Náº¿u thanh toÃ¡n tháº¥t báº¡i â†’ Tá»± Ä‘á»™ng há»§y Ä‘Æ¡n vÃ  tráº£ láº¡i stock
- Sá»­ dá»¥ng MongoDB Transaction Ä‘á»ƒ Ä‘áº£m báº£o atomic operation

---

### 2.3. Lá»£i Ã­ch khi tÃ¡ch cÃ¡c quy trÃ¬nh

#### âœ… Æ¯u Ä‘iá»ƒm:

1. **Dá»… báº£o trÃ¬**: Má»—i module cÃ³ trÃ¡ch nhiá»‡m riÃªng biá»‡t
2. **Dá»… má»Ÿ rá»™ng**: ThÃªm phÆ°Æ¡ng thá»©c thanh toÃ¡n má»›i khÃ´ng áº£nh hÆ°á»Ÿng module khÃ¡c
3. **Dá»… test**: Test tá»«ng module Ä‘á»™c láº­p
4. **PhÃ¢n quyá»n rÃµ rÃ ng**: Admin chá»‰ quáº£n lÃ½ Ä‘Æ¡n hÃ ng, khÃ´ng can thiá»‡p thanh toÃ¡n
5. **Scalability**: CÃ³ thá»ƒ scale tá»«ng service riÃªng náº¿u cáº§n (Microservices)

#### âŒ NhÆ°á»£c Ä‘iá»ƒm:

1. **Phá»©c táº¡p hÆ¡n**: Cáº§n Ä‘áº£m báº£o Ä‘á»“ng bá»™ dá»¯ liá»‡u giá»¯a cÃ¡c module
2. **Performance**: Nhiá»u API call hÆ¡n
3. **Error handling**: Pháº£i xá»­ lÃ½ lá»—i á»Ÿ nhiá»u táº§ng
4. **Transaction management**: Cáº§n Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u

---

### 2.4. Káº¿t luáº­n

**CÃ³ váº¥n Ä‘á» phá»‘i há»£p khÃ´ng?**

â†’ **CÃ“**, nhÆ°ng cÃ³ thá»ƒ giáº£i quyáº¿t Ä‘Æ°á»£c náº¿u:

1. âœ… Sá»­ dá»¥ng **MongoDB Transaction** cho cÃ¡c thao tÃ¡c liÃªn quan nhiá»u collection
2. âœ… Implement **State Machine** cho tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
3. âœ… Sá»­ dá»¥ng **Event-Driven Architecture** vá»›i Socket.io hoáº·c Message Queue
4. âœ… Implement **Webhook** cho cÃ¡c payment gateway (PayPal, MoMo)
5. âœ… ThÃªm **Retry mechanism** cho cÃ¡c API call tháº¥t báº¡i
6. âœ… Logging Ä‘áº§y Ä‘á»§ Ä‘á»ƒ debug khi cÃ³ lá»—i

**ÄÃ¡nh giÃ¡ code hiá»‡n táº¡i**:
- â­â­â­â­â˜† (4/5): Code Ä‘Ã£ tÃ¡ch module tá»‘t, nhÆ°ng cáº§n cáº£i thiá»‡n vá» transaction vÃ  error handling

---

## PHá»¤ Lá»¤C: DANH SÃCH API

### Product APIs
- `GET /` - Láº¥y táº¥t cáº£ sáº£n pháº©m
- `GET /category` - Láº¥y sáº£n pháº©m theo danh má»¥c
- `GET /:id` - Láº¥y chi tiáº¿t sáº£n pháº©m
- `GET /category/gender` - Lá»c theo giá»›i tÃ­nh
- `GET /category/pagination` - PhÃ¢n trang vÃ  tÃ¬m kiáº¿m
- `GET /scoll/page` - Scroll pagination

### Order APIs
- `GET /order/:id` - Láº¥y Ä‘Æ¡n hÃ ng cá»§a user
- `GET /order/detail/:id` - Láº¥y chi tiáº¿t Ä‘Æ¡n hÃ ng
- `POST /order` - Táº¡o Ä‘Æ¡n hÃ ng
- `POST /momo` - Callback tá»« MoMo
- `POST /email` - Gá»­i email xÃ¡c nháº­n

### Models
- `product.js` - Sáº£n pháº©m
- `order.js` - ÄÆ¡n hÃ ng
- `detail_order.js` - Chi tiáº¿t Ä‘Æ¡n hÃ ng
- `payment.js` - Thanh toÃ¡n
- `delivery.js` - Giao hÃ ng
- `cart.js` - Giá» hÃ ng
- `user.js` - NgÆ°á»i dÃ¹ng
- `coupon.js` - MÃ£ giáº£m giÃ¡

---

**NgÆ°á»i thá»±c hiá»‡n**: [TÃªn sinh viÃªn]  
**NgÃ y**: 15/10/2025  
**Lá»›p**: [MÃ£ lá»›p]  
**MÃ´n há»c**: Ká»¹ thuáº­t pháº§n má»m
